!function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(e){e.TileLayer.Offline=e.TileLayer.extend({initialize:function(t,i,o){this._url=t,this._tilesDb=i,(o=e.Util.setOptions(this,o)).detectRetina&&e.Browser.retina&&o.maxZoom>0&&(o.tileSize=Math.floor(o.tileSize/2),o.zoomReverse?(o.zoomOffset--,o.minZoom++):(o.zoomOffset++,o.maxZoom--),o.minZoom=Math.max(0,o.minZoom)),"string"==typeof o.subdomains&&(o.subdomains=o.subdomains.split("")),e.Browser.android||this.on("tileunload",this._onTileRemove)},createTile:function(t,i){var o=document.createElement("img");return e.DomEvent.on(o,"load",e.bind(this._tileOnLoad,this,i,o)),e.DomEvent.on(o,"error",e.bind(this._tileOnError,this,i,o)),this.options.crossOrigin&&(o.crossOrigin=""),o.alt="",o.setAttribute("role","presentation"),this.getTileUrl(t).then(function(e){o.src=e}).catch(function(e){throw e}),o},getTileUrl:function(t){var i=e.TileLayer.prototype.getTileUrl.call(this,t),o=this._getStorageKey(i);return this._tilesDb.getItem(o).then(function(e){return e&&"object"==typeof e?URL.createObjectURL(e):i}).catch(function(e){throw e})},getTileUrls:function(t,i){var o=[],n=this._url;this.setUrl(this._url.replace("{z}",i),!0);for(var r=e.bounds(t.min.divideBy(this.getTileSize().x).floor(),t.max.divideBy(this.getTileSize().x).floor()),s=r.min.x;s<=r.max.x;s++)for(var l=r.min.y;l<=r.max.y;l++){var a=new e.Point(s,l),f=e.TileLayer.prototype.getTileUrl.call(this,a);o.push({key:this._getStorageKey(f),url:f})}return this.setUrl(n,!0),o},_getStorageKey:function(e){var t=null;if(e.indexOf("{s}")){var i=new RegExp("["+this.options.subdomains.join("|")+"].");t=e.replace(i,this.options.subdomains[0]+".")}return t||e}}),e.tileLayer.offline=function(t,i,o){return new e.TileLayer.Offline(t,i,o)}},window),function(e,t){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("object"==typeof exports&&module.exports)module.exports=e(require("leaflet"));else if(void 0!==t){if(void 0===t.L)throw"Leaflet must be loaded first!";e(t.L)}}(function(e){e.Control.Offline=e.Control.extend({options:{position:"topleft",saveButtonHtml:"S",saveButtonTitle:"Save tiles",removeButtonHtml:"R",removeButtonTitle:"Remove tiles",minZoom:0,maxZoom:19,confirmSavingCallback:null,confirmRemovalCallback:null},initialize:function(t,i,o){this._baseLayer=t,this._tilesDb=i,e.Util.setOptions(this,o)},onAdd:function(t){var i=e.DomUtil.create("div","leaflet-control-offline leaflet-bar");return this._createButton(this.options.saveButtonHtml,this.options.saveButtonTitle,"save-tiles-button",i,this._saveTiles),this._createButton(this.options.removeButtonHtml,this.options.removeIconTitle,"remove-tiles-button",i,this._removeTiles),i},_createButton:function(t,i,o,n,r){var s=e.DomUtil.create("a",o,n);return s.innerHTML=t,s.href="#",s.title=i,e.DomEvent.disableClickPropagation(s),e.DomEvent.on(s,"click",e.DomEvent.stop),e.DomEvent.on(s,"click",r,this),e.DomEvent.on(s,"click",this._refocusOnMap,this),s},_saveTiles:function(){var t=this,i=null,o=[],n=[],r=this._map.getZoom(),s=this._map.getBounds();if(r<this.options.minZoom)t._baseLayer.fire("offline:below-min-zoom-error");else{for(var l=r;l<=this.options.maxZoom;l++)o.push(l);for(var a=0;a<o.length;a++)i=e.bounds(this._map.project(s.getNorthWest(),o[a]),this._map.project(s.getSouthEast(),o[a])),n=n.concat(this._baseLayer.getTileUrls(i,o[a]));var f=function(){t._baseLayer.fire("offline:save-start",{nTilesToSave:n.length}),t._downloadTiles(n)};this.options.confirmSavingCallback?this.options.confirmSavingCallback(n.length,f):f()}},_downloadTiles:function(e){for(var t=this,i=[],o=0;o<e.length;o++)!function(e,o){i[e]=new XMLHttpRequest,i[e].open("GET",o.url,!0),i[e].responseType="blob",i[e].onreadystatechange=function(){i[e].readyState===XMLHttpRequest.DONE&&200===i[e].status&&t._saveTile(o.key,i[e].response)},i[e].send()}(o,e[o])},_saveTile:function(e,t){var i=this;this._tilesDb.setItem(e,t).then(function(){i._baseLayer.fire("offline:tile-saved")}).catch(function(e){i._baseLayer.fire("offline:save-tile-error",{error:e})})},_removeTiles:function(){var e=this,t=function(){e._tilesDb.clear().then(function(){e._baseLayer.fire("offline:tiles-removed")}).catch(function(t){e._baseLayer.fire("offline:remove-tiles-error",{error:t})})};this.options.confirmRemovalCallback?this.options.confirmRemovalCallback(t):t()}}),e.control.offline=function(t,i,o){return new e.Control.Offline(t,i,o)}},window),function(e){"function"==typeof define&&define.amd?define(["./TileLayer.Offline","./Control.Offline"],e):"object"==typeof exports&&module.exports&&(module.exports=e(require("./TileLayer.Offline"),require("./Control.Offline")))}(function(e,t){});